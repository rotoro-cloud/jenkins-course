---
layout: article
---
Очень частый кейс для директивы when - проверка текущей ветки репозитория. Давай добавим его вторым условием для запуска stage. Если мы хотим, чтобы оба эти условия выполнялись, мы заключим их в блок `allOf`, как ты видишь.

```
pipeline {
    agent any
    environment {
        access = ''
    }
    stages {
        stage('first') {
            when {
                not {
                    allOf {
                        environment name: 'access', value: 'granted'
                        branch 'master'
                    }
                }
            }
            steps {
                echo "Just completed the first stage in ${BRANCH_NAME}"
            }
        }
    }
}
```

- `allOf` соответствует логике `И`.
- `anyOf` реализует `ИЛИ` т.е. если верно одно из условий, stage сработает.
- `not` подойдет, если не одно из условий не исполнено.

Поскольку я запускаюсь из ветки `jenkinsfiles`, и `access` также пустой, то оба значения будут в `false`. Для создания логики `AND` я использую блок `allOf`. Далее оборачиваю в блок `not`, который инвертирует результат в `true`, что запустит stage на исполнение. В самих шагах я вывожу сообщение с названием ветки. Эту переменную `BRANCH_NAME` предоставляет плагин конвейеров.

Давай проверим. Файл в репо `Jenkinsfile-8.45-3`. Как видишь, все случилось, как мы и задумывали.

Тут небольшой момент. Если **Jenkinsfile-8.45-3** падает с ошибкой, попробуй вместо `${BRANCH_NAME}` прописать `${env.BRANCH_NAME}`. В Jenkins у нас масса способов обратиться к переменным окружения, поскольку разные плагины-интеграторы расширяют это поле нотаций. Ссылка на переменную, указанная в образце, отлично работала на моем облачном стенде. Но на нём была поставлена куча плагинов, а вот в лабораторном сетапе ей чего-то не хватает. Я специально не стал это исправлять, поскольку это показалось мне хорошей иллюстрацией этой особенности.

```jsx
https://www.jenkins.io/doc/book/pipeline/syntax/#when
```

По этой ссылке ты можешь посмотреть в документации, какие еще условия поддерживает `when`, а также в каком порядке он будет оценен Jenkins по сравнению с другими блоками, и как можно изменить это поведение.
